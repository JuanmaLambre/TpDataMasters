#
#	A diferencia de perceptron.py este codigo grafica
#	(cant_reviews_pos; cant_revies_neg) por cada par de palabra que exista
#	IMPORTANTE: A difrenecia de perceptron simple (con una palabra), aca no hay
#	un archivo con todos los puntajes de cada palabra. Esto lo creamos nosotros
#	con el archivo de entrenamiento mismo.
#

import cleanText as ct
import matplotlib.pyplot as plt
import sys

# Primero que todo, creo un hash con los puntajes de cada shingle

#	Dado una lista de palabras devuelve una lista de shingles dobles palabra
def joinMultiShingles(multi, wordsList):
	shingles = []	
	for i in range(len(wordsList)-multi+1):
		# Uno las palabras a shingle:
		shingle = ""
		for j in range(multi):
			shingle += wordsList[i+j] + " "
		# Remuevo el ultimo espacio
		shingle = shingle[:len(shingle)-1]
		shingles.append( shingle )
		
	return shingles
	
	
def joinDoubleShingles(wl):
	return joinMultiShingles(2, wl)
	
	
puntajes = {}
labeled = open("../labeledTrainData.tsv", 'r')
labeled.readline()

#	Obtengo una lista de tuplas ([shingles], sentiment), una por cada review
MULTI = 10
reviewsProcesadas = []
MAX_ITERACIONES = 20000.0
iteracion = 0.0
line = labeled.readline()
print "ENTRENANDO..."
while line and iteracion < MAX_ITERACIONES:
	rawReview = line.split('\t')[2]
	cleanReview = ct.cleanText(rawReview)
	shingles = joinMultiShingles(MULTI, cleanReview)
	sentiment = int( line.split('\t')[1] )
	
	reviewsProcesadas.append( (shingles,sentiment) )
	line = labeled.readline()
	
	iteracion += 1
	sys.stdout.write("\r%d%%" % int( iteracion*100/MAX_ITERACIONES ))
	sys.stdout.flush()
	

#	Ahora lleno el hash puntajes
for review in reviewsProcesadas:
	sumaPositivo = review[1]
	sumaNegativo = not sumaPositivo
	for shingle in review[0]:
		frecuencias = puntajes[shingle] = puntajes.get(shingle, (0,0))
		frecActualizada = (frecuencias[0]+sumaNegativo, frecuencias[1]+sumaPositivo)
		puntajes[shingle] = frecActualizada


# Obtenidos los puntajes ahora voy a calificar los siguientes reviews y ver
# que tan bien o mal califico

correctos, incorrectos = 0.0, 0.0
iteracion = 0.0
MAX_PRUEBAS = 2000.0
line = labeled.readline()
print "\nPREDICIENDO..."
while line and iteracion < MAX_PRUEBAS:
	rawReview = line.split('\t')[2]
	cleanReview = ct.cleanText(rawReview)
	shingles = joinMultiShingles(MULTI, cleanReview)
	puntajePos, puntajeNeg = 0, 0
	for sh in shingles:
		puntajeShingle = puntajes.get(sh, (0,0))
		puntajePos += puntajeShingle[1]
		puntajeNeg += puntajeShingle[0]

	if (puntajePos != puntajeNeg):
		sentimientoPosta = int( line.split('\t')[1] )
		prediccion = (puntajePos > puntajeNeg)
		correctos += (prediccion == sentimientoPosta)
		incorrectos += (prediccion != sentimientoPosta)
		
	line = labeled.readline()
	iteracion += 1
	sys.stdout.write("\r%d%%" % int(iteracion*100/MAX_PRUEBAS))
		
print "\n\nMULTI =", MULTI
print "CORRECTOS:", correctos*100/(correctos+incorrectos), "%"


		
